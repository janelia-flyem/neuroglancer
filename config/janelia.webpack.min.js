
'use strict';
const webpack_helpers = require('./webpack_helpers');
const resolveReal = require('./resolve_real');
const path = require('path');
const WebpackShellPlugin = require('webpack-shell-plugin');
const webpack = require('webpack');
const CopyWebpackPlugin = require('copy-webpack-plugin');
const HtmlWebpackPlugin = require('html-webpack-plugin');

const dest = path.resolve(__dirname, '../dist/janelia-min');

const config = webpack_helpers.getViewerConfig(
  { htmlPlugin: new HtmlWebpackPlugin({template: resolveReal(__dirname, '../src/index-janelia-dist.html')}),
    outputPath: dest,
    supportedLayers: [
      'neuroglancer/segmentation_metric_user_layer',

    ].concat(webpack_helpers.DEFAULT_SUPPORTED_LAYERS)
  , minify: true,
});

const janelia_packagejson = resolveReal(__dirname, '../janelia-package.json');

//command to tar up the results
const version = require(janelia_packagejson).version;
const CREATE_ARCHIVE = `cd dist/janelia-min/ && tar -czvf dist-${version}.tar.gz . && mv dist-${version}.tar.gz ../`

config[0].plugins.push(
    new CopyWebpackPlugin([{
      from: janelia_packagejson,
      to: path.resolve(dest, 'package.json')
    }]),
    new webpack.optimize.OccurrenceOrderPlugin(),
    //.. other plugins,
    new WebpackShellPlugin({
      onBuildExit: [CREATE_ARCHIVE],
      safe: true
    })
  )

module.exports = config